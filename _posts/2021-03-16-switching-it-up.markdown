---
layout: post
title:  "Switching it up"
date:   2021-03-16 22:15:23 +0800
---

Last time we implemented a hub, the simplest non-edge node in our layer two
protocol. There are a number of downsides so far. Today we'll tackle an easy
one - the large amount of extraneous traffic generated by hubs.

Remember that this problem with our hub is due to the fact that it sends each
message it receives to every other node it is connected to, and counting on the
nodes the message isn't addressed to to ignore it. To solve this, we will keep a
cache mapping addresses we've seen messages from to the port on which those
messages have arrived. Then when receiving a message, we will only send it to
the port our cache tells us the recipient is on. If our cache doesn't know about
that address, we will fall back to our old behavior of sending the message
everywhere.

Finally, we will add some cache expiration. We want to handle connections being
moved around, so we will only keep cache entries around for a minute. This
handles the case where a node is disconnected and then reconnected to a
different port. Of course, that's only required if the reconnected node is
silent - if it sends a message, we will immediately overwrite the entry.
